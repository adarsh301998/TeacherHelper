package sample.Controllers;

import HelperClasses.Constants;
import HelperClasses.DialogPopUp;
import com.jfoenix.controls.JFXListView;
import com.jfoenix.controls.JFXTextField;
import javafx.fxml.FXML;
import javafx.geometry.Pos;
import javafx.scene.control.Label;
import javafx.scene.input.KeyEvent;
import javafx.scene.input.MouseEvent;
import javafx.scene.layout.StackPane;
import javafx.scene.layout.VBox;
import sample.DataClasses.Bus;
import sample.DataClasses.DataBaseCommunication;
import sample.DataClasses.TestDetails;

import java.io.BufferedReader;
import java.io.FileNotFoundException;
import java.io.FileReader;
import java.io.IOException;
import java.util.ArrayList;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

public class OpenTestController {
    @FXML
    private StackPane stackPane;

    @FXML
    private JFXTextField filename_txt;

    @FXML
    private JFXListView<VBox> fileNameListView;

    @FXML
    private Label noResultLabel;

    ArrayList<String> testName = new ArrayList<>();

    @FXML
    void closeEvent(MouseEvent event) {

        DialogPopUp.closeAlert(stackPane);
    }

    @FXML
    void getTestDetails(MouseEvent event) {

        int selectedIndex = fileNameListView.getSelectionModel().getSelectedIndex();

        if (selectedIndex != -1) {

            String loadTest = testName.get(selectedIndex);
            TestDetails testDetails = DataBaseCommunication.convertJSONToJava(TestDetails.class, loadTest);
            DialogPopUp dialogPopUp = new DialogPopUp();
            Bus.setInstance(testDetails);
            dialogPopUp.openTestDialog(stackPane, testDetails);

        }

    }


    public void initialize() {

        try {

            filename_txt.setOnKeyReleased(event -> filterTestName(event));
            fileNameListView.setExpanded(true);
            fileNameListView.setDepth(Constants.LIST_DEPTH);

            BufferedReader reader = new BufferedReader(new FileReader("src//Tests//testName.txt"));
            String line, data = "";
            while ((line = reader.readLine()) != null) {
                testName.add(line);
            }
            initOpenTestListView(testName);

        } catch (FileNotFoundException e) {
            e.printStackTrace();
        } catch (IOException e) {
            e.printStackTrace();
        }


    }

    private void filterTestName(KeyEvent event) {

        String testNameTxt = filename_txt.getText();
        int count = 0;
        ArrayList<String> filteredTestName = new ArrayList<>();
        if (!testName.isEmpty()) {

            for (String string : testName) {

                Pattern p = Pattern.compile(testNameTxt);
                Matcher matcher = p.matcher(string);
                //System.out.println("Hello");
                if (matcher.find()) {
                    count++;
                    filteredTestName.add(string);
                    //System.out.println(string);
                }

            }
            initOpenTestListView(filteredTestName);
            System.out.println("Count : " + count);
        }


    }

    private void initOpenTestListView(ArrayList<String> testName) {

        fileNameListView.getItems().clear();

        if (!testName.isEmpty()) {
            noResultLabel.setVisible(false);


            for (String name : testName) {

                String testNameTxt = name.substring(0, name.length() - 10);
                String testDateTxt = name.substring(name.length() - 10);


                //Setting up list element
                Label testNameLabel = new Label(testNameTxt);
                Label testDateLabel = new Label(testDateTxt);
                testDateLabel.setAlignment(Pos.BASELINE_RIGHT);
                testDateLabel.setMaxWidth(Double.MAX_VALUE);
                VBox vBox = new VBox(testNameLabel, testDateLabel);
                vBox.setSpacing(20);
                fileNameListView.getItems().add(vBox);


            }

        } else {
            noResultLabel.setVisible(true);
        }


    }


}
